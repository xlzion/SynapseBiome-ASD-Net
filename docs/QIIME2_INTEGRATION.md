# QIIME2 Integration for Microbiome Data Processing

This document describes how to integrate QIIME2 processed microbiome data with SynapseBiome ASD-Net.

## Overview

SynapseBiome ASD-Net supports microbiome data processed through QIIME2, a powerful microbiome analysis platform. The framework can directly read and process `feature_table.biom` files generated by QIIME2.

## QIIME2 Workflow

### 1. QIIME2 Processing Pipeline

Before using SynapseBiome ASD-Net, you should process your raw microbiome data through QIIME2. Here's a typical workflow:

```bash
# Import raw data
qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path raw_data/ \
  --output-path paired-end-demux.qza \
  --input-format CasavaOneEightSingleLanePerSampleDirFmt

# Quality control and denoising
qiime dada2 denoise-paired \
  --i-demultiplexed-seqs paired-end-demux.qza \
  --p-trim-left-f 13 \
  --p-trim-left-r 13 \
  --p-trunc-len-f 150 \
  --p-trunc-len-r 150 \
  --o-table table.qza \
  --o-representative-sequences rep-seqs.qza \
  --o-denoising-stats stats.qza

# Generate feature table
qiime feature-table summarize \
  --i-table table.qza \
  --o-visualization table.qzv

# Export as BIOM format
qiime tools export \
  --input-path table.qza \
  --output-path exported_seqs
```

### 2. Input Data Format

The framework expects the following QIIME2 output:

- **`feature_table.biom`**: Feature table in BIOM format
- **Sample metadata**: Optional sample information file
- **Feature metadata**: Optional feature taxonomy information

## Data Processing with SynapseBiome ASD-Net

### Command Line Interface

```bash
# Basic processing
python scripts/process_microbiome.py \
  --biom_file data/feature_table.biom \
  --output_dir data/processed/microbiome

# Advanced processing with options
python scripts/process_microbiome.py \
  --biom_file data/feature_table.biom \
  --output_dir data/processed/microbiome \
  --normalization relative_abundance \
  --transformation log \
  --feature_selection \
  --variance_threshold 0.01
```

### Processing Options

#### Normalization Methods

1. **Relative Abundance** (default)
   - Converts raw counts to proportions
   - Each sample sums to 1.0
   - Accounts for sequencing depth differences

2. **CLR (Centered Log Ratio)**
   - Applies centered log ratio transformation
   - Useful for compositional data analysis
   - Handles relative nature of microbiome data

3. **None**
   - Uses raw counts
   - Not recommended for most analyses

#### Transformation Methods

1. **Log Transformation** (default)
   - Applies log(x + ε) transformation
   - Reduces skewness in abundance distributions
   - ε = 1e-10 to avoid log(0)

2. **Square Root Transformation**
   - Applies √x transformation
   - Less aggressive than log transformation
   - Useful for count data

3. **None**
   - No transformation applied
   - May lead to skewed distributions

#### Feature Selection

- **Variance Threshold**: Removes features with low variance
- **Default threshold**: 0.01
- **Purpose**: Reduces dimensionality and noise

### Output Files

The processing script generates several output files:

```
data/processed/microbiome/
├── microbiome_processed.npy          # Processed feature matrix
├── microbiome_features.csv           # Feature metadata
├── microbiome_samples.csv            # Sample metadata
└── processing_summary.txt            # Processing summary
```

#### File Descriptions

1. **`microbiome_processed.npy`**
   - NumPy array with processed feature matrix
   - Shape: (n_samples, n_features)
   - Ready for model training

2. **`microbiome_features.csv`**
   - Feature IDs and names
   - Mean and standard deviation of abundances
   - Useful for feature interpretation

3. **`microbiome_samples.csv`**
   - Sample IDs and metadata
   - Total read counts per sample
   - Number of features per sample

4. **`processing_summary.txt`**
   - Processing parameters used
   - Data statistics
   - Quality control information

## Integration with Model Training

### Using Processed Data

```python
from src.data import ABIDE2DataProcessor

# Initialize processor
processor = ABIDE2DataProcessor(
    data_dir="data/ABIDE2",
    output_dir="data/processed"
)

# Process microbiome data from QIIME2
microbiome_path = processor.process_microbiome_data("data/feature_table.biom")

# Load processed data
microbiome_data = np.load(microbiome_path)
print(f"Microbiome data shape: {microbiome_data.shape}")
```

### Multimodal Integration

```python
from src.data import MultimodalDataProcessor

# Initialize multimodal processor
processor = MultimodalDataProcessor(
    abide1_dir="data/ABIDE1",
    abide2_dir="data/ABIDE2",
    output_dir="data/processed"
)

# Process both fMRI and microbiome data
fmri_path, microbiome_path = processor.process_abide2_data("data/feature_table.biom")

# Use in model training
# ... model training code ...
```

## Quality Control

### Data Quality Metrics

The processing pipeline includes several quality control measures:

1. **Missing Value Handling**
   - Fills missing values with zeros
   - Reports percentage of missing data

2. **Feature Variance**
   - Removes low-variance features
   - Configurable threshold

3. **Sample Quality**
   - Reports total read counts per sample
   - Identifies potential outliers

4. **Feature Abundance**
   - Calculates mean and standard deviation
   - Helps identify dominant features

### Quality Control Reports

```bash
# View processing summary
cat data/processed/microbiome/processing_summary.txt

# Check feature statistics
head -10 data/processed/microbiome/microbiome_features.csv

# Check sample statistics
head -10 data/processed/microbiome/microbiome_samples.csv
```

## Best Practices

### 1. QIIME2 Processing

- Use appropriate quality thresholds for your data
- Consider rarefaction for even sampling depth
- Include proper metadata for samples

### 2. Feature Selection

- Start with variance threshold of 0.01
- Adjust based on your specific dataset
- Consider biological relevance of features

### 3. Normalization

- Use relative abundance for most analyses
- Consider CLR for compositional data analysis
- Avoid raw counts for machine learning

### 4. Transformation

- Use log transformation for skewed distributions
- Consider square root for less skewed data
- Test different transformations on your data

## Troubleshooting

### Common Issues

1. **BIOM File Not Found**
   ```bash
   # Check if file exists
   ls -la data/feature_table.biom
   
   # Verify BIOM format
   biom validate-table -i data/feature_table.biom
   ```

2. **Memory Issues**
   ```bash
   # Use smaller batch size
   python scripts/process_microbiome.py \
     --biom_file data/feature_table.biom \
     --variance_threshold 0.05  # More aggressive filtering
   ```

3. **Import Errors**
   ```bash
   # Install required packages
   pip install biom-format pandas numpy scikit-learn
   ```

### Performance Optimization

- Use SSD storage for large datasets
- Increase variance threshold for faster processing
- Consider downsampling for very large datasets

## References

- [QIIME2 Documentation](https://docs.qiime2.org/)
- [BIOM Format Specification](http://biom-format.org/)
- [Microbiome Data Analysis Best Practices](https://www.nature.com/articles/s41592-019-0459-y) 